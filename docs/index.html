<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wear Simulation - Physics-Based Surface Wear Analysis</title>
<link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div id="loadingScreen">
    <div class="spinner"></div>
    <div>Loading...</div>
  </div>

  <div id="hud" style="display:none;">
    <div class="panel" id="controls">
      <div class="section-title purple">Contact Analysis Controls</div>
      
      <!-- Statistics Section -->
      <div class="section">
        <div class="section-title purple collapsible" data-target="statsDetails">
          <span class="toggle-icon">â–¼</span> Statistics
        </div>
        <div id="statsDetails" class="section-details">
          <div><span class="pill cyan">Step Counter</span> <span id="stepCounter">0</span></div>
          <div><span class="pill">Frame</span> <span id="frame">0</span></div>
          <div><span class="pill">Contacts</span> <span id="contacts">0</span></div>
          <div style="padding-left: 10px;">
            <span class="pill" style="background: #dc2626;">Real</span> <span id="realContacts">0</span>
            <span class="pill" style="background: #ea580c; margin-left: 8px;">Synthetic</span> <span id="syntheticContacts">0</span>
          </div>
          <div><span class="pill">OBB Angle</span> <span id="obbAng">â€”</span></div>
          <div><span class="pill">Geom Center</span> <span id="gcenter">â€”</span></div>
          <div><span class="pill">Box Type</span> <span id="bboxType">OMBB</span></div>
          <div><span class="pill">Velocity</span> <span id="velocity">â€”</span></div>
          <div><span class="pill">Angular Vel</span> <span id="angularVel">â€”</span></div>
          <div><span class="pill cyan">Angular Momentum (L)</span> <span id="angularMomentum">â€”</span></div>
          <div><span class="pill orange">Stamp Timestep (Î´t)</span> <span id="stampTimestep">â€”</span></div>
          <div><span class="pill orange">PiP Timestep (Î´t)</span> <span id="pipTimestep">â€”</span></div>
          <div><span class="pill orange">Max Sliding Dist</span> <span id="maxSlidingDist">â€”</span></div>
          <div><span class="pill purple">Accumulated Sliding Dist</span> <span id="accumulatedSlidingDist">â€”</span></div>
          <div><span class="pill">Applied Force</span> <span id="appliedForce">0 N</span></div>
          <div><span class="pill">FPS</span> <span id="fps">0</span></div>
        </div>
      </div>
      
      <!-- Simulation Controls Section -->
      <div class="section">
        <div class="section-title green collapsible" data-target="simulationControlsDetails">
          <span class="toggle-icon">â–¼</span> Simulation Controls
        </div>
        <div id="simulationControlsDetails" class="section-details">
        <div class="row">
          <button id="start">Start</button>
          <button id="reset">Reset</button>
          <button id="pause">Pause</button>
        </div>

        <div class="row">
          <button id="stepFrame" style="width: 100%; background: #8b5cf6;">Step Frame</button>
        </div>

        <div class="row">
          <span class="label">Algorithm</span>
          <select id="bboxAlgo">
            <option value="aabb" selected>AABB (Axis-Aligned)</option>
            <option value="obb">OBB (PCA-based)</option>
            <option value="ombb">OMBB (Rotating Calipers)</option>
            <option value="kdop8">KDOP-8 â†’ OBB</option>
          </select>
        </div>

        <div class="row">
          <label><input type="checkbox" id="showWallObstacle" /> Wall Obstacle</label>
        </div>
        </div>
      </div>
      
      
      <!-- Physics & Simulation Section -->
      <div class="section">
        <div class="section-title red collapsible" data-target="physicsSimulationDetails">
          <span class="toggle-icon">â–¼</span> Physics & Simulation
        </div>
        <div id="physicsSimulationDetails" class="section-details">

        <!-- Padding Controls Subsection -->
        <div class="subsection">
          <div class="subsection-title collapsible" data-target="paddingControlsDetails">
            <span class="toggle-icon">â–¶</span> Padding Controls
          </div>
          <div id="paddingControlsDetails" class="subsection-details" style="display: none;">
            <div class="row">
              <span class="label">Padding Width</span>
              <input id="paddingWidth" type="range" min="50" max="400" value="100" step="10" />
              <span id="paddingWidthVal" class="pill">1.00x</span>
            </div>

            <div class="row">
              <span class="label">Padding Height</span>
              <input id="paddingHeight" type="range" min="50" max="400" value="100" step="10" />
              <span id="paddingHeightVal" class="pill">1.00x</span>
            </div>

            <div class="row">
              <span class="label">Padding Depth Top</span>
              <input id="paddingDepthTop" type="range" min="1" max="500" value="10" step="1" />
              <span id="paddingDepthTopVal" class="pill">0.10x</span>
            </div>

            <div class="row">
              <span class="label">Padding Depth Bottom</span>
              <input id="paddingDepthBottom" type="range" min="1" max="500" value="10" step="1" />
              <span id="paddingDepthBottomVal" class="pill">0.10x</span>
            </div>
          </div>
        </div>

        <!-- Speed Controls Subsection -->
        <div class="subsection">
          <div class="subsection-title collapsible" data-target="speedControlsDetails">
            <span class="toggle-icon">â–¶</span> Speed Controls
          </div>
          <div id="speedControlsDetails" class="subsection-details" style="display: none;">
            <div class="row">
              <span class="label">Speed X</span>
              <input id="speedX" type="range" min="-60" max="60" value="1" step="1" />
              <span id="speedXVal" class="pill">1</span>
            </div>

            <div class="row">
              <span class="label">Speed Z</span>
              <input id="speedZ" type="range" min="-60" max="60" value="0" step="1" />
              <span id="speedZVal" class="pill">0</span>
            </div>
          </div>
        </div>

        <!-- Force Controls Subsection -->
        <div class="subsection">
          <div class="subsection-title collapsible" data-target="forceControlsDetails">
            <span class="toggle-icon">â–¶</span> Force Controls
          </div>
          <div id="forceControlsDetails" class="subsection-details" style="display: none;">
            <div class="row">
              <span class="label">Force X (at base)</span>
              <input id="forceX" type="range" min="0" max="20" value="0" step="0.5" />
              <span id="forceXVal" class="pill">0</span>
            </div>

            <div class="row">
              <span class="label">Force Y</span>
              <input id="forceY" type="range" min="0" max="20" value="0" step="0.5" />
              <span id="forceYVal" class="pill">0</span>
            </div>

            <div class="row">
              <span class="label">Force Z (at base)</span>
              <input id="forceZ" type="range" min="0" max="20" value="0" step="0.5" />
              <span id="forceZVal" class="pill">0</span>
            </div>
          </div>
        </div>

        <!-- Angular Velocity Controls Subsection -->
        <div class="subsection">
          <div class="subsection-title collapsible" data-target="angularVelocityControlsDetails">
            <span class="toggle-icon">â–¶</span> Angular Velocity Controls
          </div>
          <div id="angularVelocityControlsDetails" class="subsection-details" style="display: none;">
            <div class="row">
              <span class="label">Torque X (rad/s impulse)</span>
              <input id="torqueX" type="range" min="0" max="20" value="0" step="0.5" />
              <span id="torqueXVal" class="pill">0</span>
            </div>

            <div class="row">
              <span class="label">Torque Y (rad/s impulse)</span>
              <input id="torqueY" type="range" min="0" max="20" value="0" step="0.5" />
              <span id="torqueYVal" class="pill">0</span>
            </div>

            <div class="row">
              <span class="label">Torque Z (rad/s impulse)</span>
              <input id="torqueZ" type="range" min="0" max="20" value="0" step="0.5" />
              <span id="torqueZVal" class="pill">0</span>
            </div>

            <div class="row">
              <button id="applyTorque" style="width: 100%; background: #06b6d4;">Apply Angular Impulse</button>
            </div>
            <div class="row">
              <button id="stopRotation" style="width: 100%; background: #ef4444;">Stop Rotation</button>
            </div>
          </div>
        </div>

        <!-- Physics Parameters Subsection -->
        <div class="subsection">
          <div class="subsection-title collapsible" data-target="physicsParametersDetails">
            <span class="toggle-icon">â–¶</span> Physics Parameters
          </div>
          <div id="physicsParametersDetails" class="subsection-details" style="display: none;">
            <div class="row">
              <span class="label">Gravity</span>
              <input id="gravity" type="range" min="981" max="20000" value="981" step="1" />
              <span id="gravityVal" class="pill">9.81</span>
            </div>

            <div class="row">
              <span class="label">Friction</span>
              <input id="friction" type="range" min="0" max="2.0" value="0" step="0.01" />
              <span id="frictionVal" class="pill">0.00</span>
            </div>

            <div class="row">
              <span class="label">Restitution</span>
              <input id="restitution" type="range" min="0" max="1.0" value="0.6" step="0.01" />
              <span id="restitutionVal" class="pill">0.60</span>
            </div>

            <div class="row">
              <span class="label">Linear Damping</span>
              <input id="linearDamping" type="range" min="0" max="100" value="1" step="1" />
              <span id="linearDampingVal" class="pill">0.01</span>
            </div>

            <div class="row">
              <span class="label">Angular Damping</span>
              <input id="angularDamping" type="range" min="0" max="100" value="3" step="1" />
              <span id="angularDampingVal" class="pill">0.03</span>
            </div>

            <div class="row">
              <span class="label">Timestep (Hz)</span>
              <input id="timestep" type="range" min="30" max="480" value="60" step="10" />
              <span id="timestepVal" class="pill">60 Hz</span>
            </div>

            <div class="row">
              <span class="label">Max Substeps</span>
              <input id="maxSubsteps" type="range" min="1" max="50" value="10" step="1" />
              <span id="maxSubstepsVal" class="pill">10</span>
            </div>

            <div class="row">
              <span class="label">Fixed Timestep (Hz)</span>
              <input id="fixedTimestep" type="range" min="60" max="480" value="120" step="10" />
              <span id="fixedTimestepVal" class="pill">120 Hz</span>
            </div>

            <div class="row">
              <span class="label">Sub-stepping</span>
              <input id="subStepping" type="range" min="1" max="20" value="1" step="1" />
              <span id="subSteppingVal" class="pill">1</span>
            </div>
          </div>
        </div>

        </div>
      </div>
      
      <!-- Body Configuration Section -->
      <div class="section">
        <div class="section-title blue collapsible" data-target="bodyConfigDetails">
          <span class="toggle-icon">â–¼</span> Body Configuration
        </div>
        <div id="bodyConfigDetails" class="section-details">
        <div class="row">
          <span class="label">Body</span>
          <select id="shape">
            <option value="cube10" selected>Cube (subdiv 10)</option>
            <option value="cubeSoft">Cube Soft (Volume)</option>
            <option value="sphere">Sphere</option>
            <option value="puck">Puck (torus)</option>
            <option value="puckCylinder">Hockey Puck (cylinder)</option>
            <option value="cone">Cone</option>
            <option value="custom">Custom GLB</option>
          </select>
        </div>
        
        <div class="row" id="customBodyRow" style="display:none;">
          <span class="label">Body GLB</span>
          <input id="bodyFile" type="file" accept=".glb,.gltf" />
        </div>

        <div class="row" id="variantRow" style="display:none;">
          <span class="label">Material Variant</span>
          <select id="variantSelect">
            <option value="-1">No variants available</option>
          </select>
          <span id="variantCount" class="pill cyan">0</span>
        </div>
        
        <div class="row">
          <span class="label">Mass</span>
          <input id="mass" type="range" min="0.1" max="1000" step="0.1" value="2" />
          <span id="massValue" class="pill">2.0 kg</span>
        </div>
        
        </div>
      </div>
      
      <!-- Soft Body Parameters Section -->
      <div class="section" id="softBodySection" style="display:none;">
        <div class="section-title purple">Soft Body Parameters</div>
        <div class="row">
          <span class="label">Stiffness</span>
          <input id="softStiffness" type="range" min="1" max="100" value="5" step="1" />
          <span id="softStiffnessVal" class="pill">0.05</span>
        </div>
        
        <div class="row">
          <span class="label">Damping</span>
          <input id="softDamping" type="range" min="0" max="50" value="1" step="1" />
          <span id="softDampingVal" class="pill">0.01</span>
        </div>
        
        <div class="row">
          <span class="label">Pressure</span>
          <input id="softPressure" type="range" min="0" max="500" value="0" step="10" />
          <span id="softPressureVal" class="pill">0.00</span>
        </div>
        
        <div class="row">
          <span class="label">Solver Iterations</span>
          <input id="softIterations" type="range" min="10" max="100" value="40" step="5" />
          <span id="softIterationsVal" class="pill">40</span>
        </div>
        
        <div class="row">
          <span class="label">Contact Hardness</span>
          <input id="softContactHardness" type="range" min="0" max="100" value="100" step="5" />
          <span id="softContactHardnessVal" class="pill">1.00</span>
        </div>
        
        <div class="row">
          <p style="font-size: 10px; color: #999; margin: 0;">Higher subdivision = more contacts (9Ã—9Ã—9 = 729 nodes)</p>
        </div>
      </div>
      
      <!-- Visualization Toggles Section -->
      <div class="section">
        <div class="section-title yellow collapsible" data-target="visualizationDetails">
          <span class="toggle-icon">â–¼</span> Visualization
        </div>
        <div id="visualizationDetails" class="section-details">
        <div class="row">
          <label><input type="checkbox" id="pipEnabled" checked /> PiP Views</label>
          <label><input type="checkbox" id="showOBB" /> Show 3D Box</label>
        </div>

        <div class="row">
          <label><input type="checkbox" id="showContacts" /> Contact Points</label>
          <label><input type="checkbox" id="showGeomCenter" /> Geometric Center</label>
        </div>

        <div class="row">
          <label><input type="checkbox" id="enableSynthetic" checked /> Enable Synthetic Augmentation</label>
        </div>
        </div>
      </div>

      <!-- Variant Ground -->
      <div class="section">
        <div class="section-title cyan collapsible" data-target="variantGroundDetails">
          <span class="toggle-icon">â–¶</span> Variant Ground
        </div>
        <div id="variantGroundDetails" class="section-details" style="display:none;">
        <div class="row">
          <label class="file-upload-btn" for="loadGroundGLB">ðŸ“¦ Load Ground GLB</label>
          <input id="loadGroundGLB" type="file" accept=".glb,.gltf" style="display:none;" />
          <button id="removeVariantGround" class="save-btn" disabled style="margin-left: 5px;">Remove</button>
        </div>

        <div class="row" id="variantGroundSelectRow" style="display:none;">
          <span class="label">Material Variant</span>
          <select id="variantGroundSelect">
            <option value="0">Variant 1</option>
          </select>
        </div>

        <div class="row">
          <span class="label">Scale</span>
          <input id="variantGroundScale" type="range" min="1" max="10000" value="100" step="1" />
          <span id="variantGroundScaleVal" class="pill">1.00x</span>
        </div>

        <div class="row">
          <span class="label">Blend Smoothness</span>
          <input id="variantSmoothness" type="range" min="0" max="1" value="0.5" step="0.01" />
          <span id="variantSmoothnessVal" class="pill">0.50</span>
        </div>

        <div class="row">
          <span class="label">Blend Contrast</span>
          <input id="variantContrast" type="range" min="0.1" max="3" value="1" step="0.01" />
          <span id="variantContrastVal" class="pill">1.00</span>
        </div>

        <div class="row">
          <label><input type="checkbox" id="variantInvert" /> Invert Blend</label>
        </div>

        <div class="row">
          <div style="font-size: 10px; color: #7a8a9e; margin-top: 4px; line-height: 1.4;">
            <div><strong>Variants:</strong> <span id="variantCountDisplay">0</span></div>
            <div id="variantNamesList" style="margin-top: 2px; padding-left: 8px; max-height: 60px; overflow-y: auto;"></div>
          </div>
        </div>
        </div>
      </div>

      <!-- Ground Stamping -->
      <div class="section">
        <div class="section-title orange collapsible" data-target="groundStampingDetails">
          <span class="toggle-icon">â–¼</span> Ground Stamping
        </div>
        <div id="groundStampingDetails" class="section-details">
        <div class="row">
          <label><input type="checkbox" id="enableStamping" checked /> Enable Stamping</label>
          <label><input type="checkbox" id="showStamps" /> Show Stamps</label>
        </div>
        
        <div class="row">
          <label><input type="checkbox" id="useBBoxCenter" /> Use BBox Center</label>
        </div>
        <div class="row">
          <span class="label">Stamp Interval</span>
          <input id="stampInterval" type="range" min="1" max="500" value="50" step="1" />
          <span id="stampIntervalVal" class="pill">50 ms</span>
        </div>
        
        <div class="row">
          <button id="clearStamps" class="save-btn">Clear Stamps</button>
          <button id="saveStamps" class="save-btn">Save Stamps</button>
        </div>
        </div>
      </div>

      <!-- Ground Wear Simulation -->
      <div class="section">
        <div class="section-title cyan collapsible" data-target="wearSimulationDetails">
          <span class="toggle-icon">â–¼</span> Ground Wear Simulation
        </div>
        <div id="wearSimulationDetails" class="section-details">
        <div class="row">
          <span class="label">Wear Coefficient (K)</span>
          <input id="wearK" type="range" min="1" max="100" value="15" step="1" />
          <span id="wearKVal" class="pill">0.15</span>
        </div>

        <div class="row" style="font-size: 11px; color: #7a8a9e;">
          Uses friction coefficient (Î¼) from Physics Parameters
        </div>

        <div class="row">
          <button id="clearFlow" class="save-btn">Clear Wear Data</button>
          <button id="saveFlow" class="save-btn">Export Wear Map</button>
        </div>
        <div class="row">
          <label><input type="checkbox" id="showFlowOverlay" checked /> Show Ground Wear Overlay</label>
        </div>
        <div class="row">
          <span class="label">Display Mode</span>
          <select id="wearDisplayMode">
            <option value="hsva">HSVA (Direction + Wear)</option>
            <option value="rgba">RGBA (4-Channel Encoding)</option>
          </select>
        </div>
        </div>
      </div>

      <!-- Sliding Distance Analysis -->
      <div class="section">
        <div class="section-title purple collapsible" data-target="slidingDistDetails">
          <span class="toggle-icon">â–¶</span> Sliding Distance Analysis
        </div>
        <div id="slidingDistDetails" class="section-details" style="display:none;">
          <div class="row">
            <label><input type="checkbox" id="showSlidingOverlay" /> Show Sliding Distance Overlay</label>
          </div>

          <div class="row">
            <span class="label">Sliding K Factor</span>
            <input id="slidingKFactor" type="range" min="0.01" max="5.0" value="0.15" step="0.01" />
            <span id="slidingKFactorVal" class="pill">0.15</span>
          </div>

          <div class="row">
            <button id="clearSlidingDist" class="btn-small">Clear Sliding Distance</button>
          </div>

          <div class="row">
            <span class="label-info">
              Max Accumulated: <span id="maxSlidingDistDisplay" class="pill">â€”</span>
            </span>
          </div>
        </div>
      </div>

      <!-- Wear Map Normalization -->
      <div class="section">
        <div class="section-title orange collapsible" data-target="wearNormDetails">
          <span class="toggle-icon">â–¶</span> Wear Map Normalization (RGBA Mode)
        </div>
        <div id="wearNormDetails" class="section-details" style="display:none;">
          <div class="row">
            <span class="label-info" style="font-size: 0.85em; color: #888;">Note: Controls below only apply when Display Mode is set to "RGBA (4-Channel Encoding)"</span>
          </div>
          <div class="row">
            <span class="label">Wear K Factor</span>
            <input id="wearK" type="range" min="1" max="100" value="15" step="1" />
            <span id="wearKVal" class="pill">0.15</span>
          </div>

          <!-- Normalization ranges for RGB encoding -->
          <div class="row">
            <span class="label">Max Velocity (m/s)</span>
            <input id="maxVelocityNorm" type="range" min="0.5" max="10" value="2" step="0.1" />
            <span id="maxVelocityNormVal" class="pill">2.0 m/s</span>
          </div>

          <div class="row">
            <span class="label">Max Traction Force (N)</span>
            <input id="maxTractionNorm" type="range" min="1" max="100" value="20" step="1" />
            <span id="maxTractionNormVal" class="pill">20 N</span>
          </div>

          <div class="row">
            <span class="label">Max Sliding Distance (m)</span>
            <input id="maxSlidingNorm" type="range" min="0.1" max="50" value="10" step="0.1" />
            <span id="maxSlidingNormVal" class="pill">10 m</span>
          </div>

          <!-- Display current maximums -->
          <div class="row">
            <span class="label-info">Current Max Velocity: <span id="currentMaxVel" class="pill">â€”</span></span>
          </div>
          <div class="row">
            <span class="label-info">Current Max Traction: <span id="currentMaxTraction" class="pill">â€”</span></span>
          </div>
          <div class="row">
            <span class="label-info">Current Max Sliding: <span id="currentMaxSliding" class="pill">â€”</span></span>
          </div>
          <div class="row">
            <span class="label-info">Max Wear (RÃ—GÃ—B): <span id="maxWearDisplay" class="pill">â€”</span></span>
          </div>

          <div class="row">
            <button id="clearWear" class="btn-small">Clear Wear Data</button>
          </div>
        </div>
      </div>

    </div>

  </div>

  <div class="pip-container scrollable" id="pipContainer">
    <div id="pip1" class="pip">
      <div class="pip-label">Top View (+n)</div>
      <canvas id="pip1Canvas" width="256" height="256"></canvas>
    </div>
    <div id="pip2" class="pip">
      <div class="pip-label">Bottom View (-n)</div>
      <canvas id="pip2Canvas" width="256" height="256"></canvas>
    </div>
    <div id="pip3" class="pip">
      <div class="pip-label">Intersection</div>
      <canvas id="pip3Canvas" width="256" height="256"></canvas>
    </div>
    <div id="pip4" class="pip">
      <div class="pip-label">Tangential Velocity</div>
      <canvas id="pip4Canvas" width="256" height="256"></canvas>
    </div>
    <div id="pip5" class="pip">
      <div class="pip-label">Instant Tangential Traction (N/mÂ²)</div>
      <canvas id="pip5Canvas" width="256" height="256"></canvas>
    </div>
    <div id="pip6" class="pip">
      <div class="pip-label">PiP6: Accumulated Sliding Distance (Ground Canvas) | Max: <span id="pip6MaxDist">â€”</span></div>
      <canvas id="pip6Canvas" width="256" height="256"></canvas>
    </div>
    <div id="pip7" class="pip">
      <div class="pip-label">Local Sliding Distance (HSV) | Max: <span id="pip7MaxDist">â€”</span></div>
      <canvas id="pip7Canvas" width="256" height="256"></canvas>
    </div>
    <div id="pip8" class="pip">
      <div class="pip-label">Local Wear Map | Max: <span id="pip8MaxWear">â€”</span></div>
      <canvas id="pip8Canvas" width="256" height="256"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/gh/kripken/ammo.js@HEAD/builds/ammo.js"></script>
  <script type="importmap">
  {"imports":{
    "three":"https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
    "three/addons/":"https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/"
  }}
  </script>
  <script type="module" src="js/main-clean-complete.js"></script>
</body>
</html>
