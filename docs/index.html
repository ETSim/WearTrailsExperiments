<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PiP OBB Physics - Enhanced Collision Visualization</title>
<link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div id="loadingScreen">
    <div class="spinner"></div>
    <div>Loading...</div>
  </div>

  <div id="hud" style="display:none;">
    <div class="panel" id="controls">
      <div class="section-title purple">Contact Analysis Controls</div>
      
      <!-- Statistics Section -->
      <div class="section">
        <div class="section-title purple collapsible" data-target="statsDetails">
          <span class="toggle-icon">▼</span> Statistics
        </div>
        <div id="statsDetails" class="section-details">
          <div><span class="pill">Frame</span> <span id="frame">0</span></div>
          <div><span class="pill">Contacts</span> <span id="contacts">0</span></div>
          <div><span class="pill">OBB Angle</span> <span id="obbAng">—</span></div>
          <div><span class="pill">Geom Center</span> <span id="gcenter">—</span></div>
          <div><span class="pill">Box Type</span> <span id="bboxType">OMBB</span></div>
          <div><span class="pill">Velocity</span> <span id="velocity">—</span></div>
          <div><span class="pill">Angular Vel</span> <span id="angularVel">—</span></div>
          <div><span class="pill">Applied Force</span> <span id="appliedForce">0 N</span></div>
          <div><span class="pill">FPS</span> <span id="fps">0</span></div>
        </div>
      </div>
      
      <!-- Simulation Controls Section -->
      <div class="section">
        <div class="section-title green collapsible" data-target="simulationControlsDetails">
          <span class="toggle-icon">▼</span> Simulation Controls
        </div>
        <div id="simulationControlsDetails" class="section-details">
        <div class="row">
          <button id="start">Start</button>
          <button id="reset">Reset</button>
          <button id="pause">Pause</button>
        </div>
        
        <div class="row">
          <span class="label">Algorithm</span>
          <select id="bboxAlgo">
            <option value="aabb" selected>AABB (Axis-Aligned)</option>
            <option value="obb">OBB (PCA-based)</option>
            <option value="ombb">OMBB (Rotating Calipers)</option>
            <option value="kdop8">KDOP-8 → OBB</option>
          </select>
        </div>
        
        <div class="row">
          <label><input type="checkbox" id="showWallObstacle" /> Wall Obstacle</label>
        </div>
        </div>
      </div>
      
      
      <!-- Physics & Simulation Section -->
      <div class="section">
        <div class="section-title red collapsible" data-target="physicsSimulationDetails">
          <span class="toggle-icon">▼</span> Physics & Simulation
        </div>
        <div id="physicsSimulationDetails" class="section-details">
        <div class="row">
          <span class="label">Padding Width</span>
          <input id="paddingWidth" type="range" min="50" max="400" value="100" step="10" />
          <span id="paddingWidthVal" class="pill">1.00x</span>
        </div>
      
        <div class="row">
          <span class="label">Padding Height</span>
          <input id="paddingHeight" type="range" min="50" max="400" value="100" step="10" />
          <span id="paddingHeightVal" class="pill">1.00x</span>
        </div>
        
        <div class="row">
          <span class="label">Padding Depth Top</span>
          <input id="paddingDepthTop" type="range" min="1" max="500" value="10" step="1" />
          <span id="paddingDepthTopVal" class="pill">0.10x</span>
        </div>
        
        <div class="row">
          <span class="label">Padding Depth Bottom</span>
          <input id="paddingDepthBottom" type="range" min="1" max="500" value="10" step="1" />
          <span id="paddingDepthBottomVal" class="pill">0.10x</span>
        </div>
        
        <div class="row">
          <span class="label">Speed X</span>
          <input id="speedX" type="range" min="-60" max="60" value="1" step="1" />
          <span id="speedXVal" class="pill">1</span>
        </div>
        
        <div class="row">
          <span class="label">Speed Z</span>
          <input id="speedZ" type="range" min="-60" max="60" value="0" step="1" />
          <span id="speedZVal" class="pill">0</span>
        </div>
        
        <div class="row">
          <span class="label">Force X</span>
          <input id="forceX" type="range" min="-2000" max="2000" value="0" step="10" />
          <span id="forceXVal" class="pill">0</span>
        </div>
        
        <div class="row">
          <span class="label">Force Y</span>
          <input id="forceY" type="range" min="-2000" max="2000" value="0" step="10" />
          <span id="forceYVal" class="pill">0</span>
        </div>
        
        <div class="row">
          <span class="label">Force Z</span>
          <input id="forceZ" type="range" min="-2000" max="2000" value="0" step="10" />
          <span id="forceZVal" class="pill">0</span>
        </div>
        
        <div class="row">
          <span class="label">Gravity</span>
          <input id="gravity" type="range" min="981" max="20000" value="981" step="1" />
          <span id="gravityVal" class="pill">9.81</span>
        </div>
        
        <div class="row">
          <span class="label">Friction</span>
          <input id="friction" type="range" min="0" max="2.0" value="0" step="0.01" />
          <span id="frictionVal" class="pill">0.00</span>
        </div>
        
        <div class="row">
          <span class="label">Restitution</span>
          <input id="restitution" type="range" min="0" max="1.0" value="0.6" step="0.01" />
          <span id="restitutionVal" class="pill">0.60</span>
        </div>
        
        <div class="row">
          <span class="label">Linear Damping</span>
          <input id="linearDamping" type="range" min="0" max="100" value="1" step="1" />
          <span id="linearDampingVal" class="pill">0.01</span>
        </div>
        
        <div class="row">
          <span class="label">Angular Damping</span>
          <input id="angularDamping" type="range" min="0" max="100" value="3" step="1" />
          <span id="angularDampingVal" class="pill">0.03</span>
        </div>
        
        <div class="row">
          <span class="label">Timestep (Hz)</span>
          <input id="timestepHz" type="range" min="30" max="480" value="60" step="10" />
          <span id="timestepHzVal" class="pill">60 Hz</span>
        </div>
        
        <div class="row">
          <span class="label">Max Substeps</span>
          <input id="maxSubsteps" type="range" min="1" max="50" value="10" step="1" />
          <span id="maxSubstepsVal" class="pill">10</span>
        </div>
        
        <div class="row">
          <span class="label">Fixed Timestep</span>
          <input id="fixedTimestep" type="range" min="60" max="480" value="120" step="10" />
          <span id="fixedTimestepVal" class="pill">120 Hz</span>
        </div>
        </div>
      </div>
      
      <!-- Body Configuration Section -->
      <div class="section">
        <div class="section-title blue collapsible" data-target="bodyConfigDetails">
          <span class="toggle-icon">▼</span> Body Configuration
        </div>
        <div id="bodyConfigDetails" class="section-details">
        <div class="row">
          <span class="label">Body</span>
          <select id="shape">
            <option value="cube10" selected>Cube (subdiv 10)</option>
            <option value="cubeSoft">Cube Soft (Volume)</option>
            <option value="sphere">Sphere</option>
            <option value="puck">Puck (torus)</option>
            <option value="cone">Cone</option>
            <option value="custom">Custom GLB</option>
          </select>
        </div>
        
        <div class="row" id="customBodyRow" style="display:none;">
          <span class="label">Body GLB</span>
          <input id="bodyFile" type="file" accept=".glb,.gltf" />
        </div>
        
        <div class="row">
          <span class="label">Mass</span>
          <input id="mass" type="range" min="0.1" max="1000" step="0.1" value="2" />
          <span id="massValue" class="pill">2.0 kg</span>
        </div>
        
        </div>
      </div>
      
      <!-- Soft Body Parameters Section -->
      <div class="section" id="softBodySection" style="display:none;">
        <div class="section-title purple">Soft Body Parameters</div>
        <div class="row">
          <span class="label">Stiffness</span>
          <input id="softStiffness" type="range" min="1" max="100" value="5" step="1" />
          <span id="softStiffnessVal" class="pill">0.05</span>
        </div>
        
        <div class="row">
          <span class="label">Damping</span>
          <input id="softDamping" type="range" min="0" max="50" value="1" step="1" />
          <span id="softDampingVal" class="pill">0.01</span>
        </div>
        
        <div class="row">
          <span class="label">Pressure</span>
          <input id="softPressure" type="range" min="0" max="500" value="0" step="10" />
          <span id="softPressureVal" class="pill">0.00</span>
        </div>
        
        <div class="row">
          <span class="label">Solver Iterations</span>
          <input id="softIterations" type="range" min="10" max="100" value="40" step="5" />
          <span id="softIterationsVal" class="pill">40</span>
        </div>
        
        <div class="row">
          <span class="label">Contact Hardness</span>
          <input id="softContactHardness" type="range" min="0" max="100" value="100" step="5" />
          <span id="softContactHardnessVal" class="pill">1.00</span>
        </div>
        
        <div class="row">
          <span class="label">Ground Threshold</span>
          <input id="softGroundThreshold" type="range" min="5" max="50" value="15" step="1" />
          <span id="softGroundThresholdVal" class="pill">0.15</span>
        </div>
        
        <div class="row">
          <p style="font-size: 10px; color: #999; margin: 0;">Higher subdivision = more contacts (9×9×9 = 729 nodes)</p>
        </div>
      </div>
      
      <!-- Visualization Toggles Section -->
      <div class="section">
        <div class="section-title yellow collapsible" data-target="visualizationDetails">
          <span class="toggle-icon">▼</span> Visualization
        </div>
        <div id="visualizationDetails" class="section-details">
        <div class="row">
          <label><input type="checkbox" id="pipEnabled" checked /> PiP Views</label>
          <label><input type="checkbox" id="showOBB" /> Show 3D Box</label>
        </div>
        
        <div class="row">
          <label><input type="checkbox" id="showPiP4" checked /> Show Line Stencil</label>
        </div>
        
        <div class="row">
          <label><input type="checkbox" id="showContacts" /> Contact Points</label>
          <label><input type="checkbox" id="showGeomCenter" /> Geometric Center</label>
        </div>
        
        <div class="row">
        </div>
        </div>
      </div>
      
      <!-- Ground Stamping -->
      <div class="section">
        <div class="section-title orange collapsible" data-target="groundStampingDetails">
          <span class="toggle-icon">▼</span> Ground Stamping
        </div>
        <div id="groundStampingDetails" class="section-details">
        <div class="row">
          <label><input type="checkbox" id="enableStamping" checked /> Enable Stamping</label>
          <label><input type="checkbox" id="showStamps" /> Show Stamps</label>
        </div>
        
        <div class="row">
          <label><input type="checkbox" id="useBBoxCenter" /> Use BBox Center</label>
        </div>
        <div class="row">
          <span class="label">Stamp Interval</span>
          <input id="stampInterval" type="range" min="1" max="500" value="50" step="1" />
          <span id="stampIntervalVal" class="pill">50 ms</span>
        </div>
        
        <div class="row">
          <button id="clearStamps" class="save-btn">Clear Stamps</button>
          <button id="saveStamps" class="save-btn">Save Stamps</button>
        </div>
        </div>
      </div>
      
      <!-- Line Stencil -->
      <div class="section">
        <div class="section-title blue collapsible" data-target="lineStencilDetails">
          <span class="toggle-icon">▼</span> Line Stencil (Physics-Responsive)
        </div>
        <div id="lineStencilDetails" class="section-details">
        <div class="row">
          <label><input type="checkbox" id="stampLineStencil" checked /> Stamp Line Stencil</label>
        </div>
        <div class="row">
          <label><input type="checkbox" id="useCustomPattern" /> Use Custom Pattern</label>
        </div>
        <div class="row">
          <input id="patternFile" type="file" accept=".png" style="display: none;" />
          <button id="selectPattern" class="save-btn">Select PNG Pattern</button>
        </div>

        <div class="row">
          <p style="font-size: 10px; color: #4ade80; margin: 0;">⚡ Pattern dynamically responds to velocity & normal force</p>
        </div>

        <div class="row">
          <span class="label">Base Line Spacing</span>
          <input id="lineSpacing" type="range" min="4" max="20" value="8" step="1" />
          <span id="lineSpacingVal" class="pill">8 px</span>
        </div>
        <div class="row" style="font-size: 11px; color: #888;">
          <span class="label">→ Actual Spacing</span>
          <span id="actualSpacing" class="pill" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">8.0 px</span>
        </div>

        <div class="row">
          <span class="label">Base Line Width</span>
          <input id="lineWidth" type="range" min="1" max="6" value="2" step="1" />
          <span id="lineWidthVal" class="pill">2 px</span>
        </div>
        <div class="row" style="font-size: 11px; color: #888;">
          <span class="label">→ Actual Width</span>
          <span id="actualWidth" class="pill" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">2.0 px</span>
        </div>

        <div class="row">
          <span class="label">Intensity Scale</span>
          <input id="lineIntensity" type="range" min="10" max="300" value="100" step="10" />
          <span id="lineIntensityVal" class="pill">100%</span>
        </div>
        <div class="row" style="font-size: 11px; color: #888;">
          <span class="label">→ Actual Intensity</span>
          <span id="actualIntensity" class="pill" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">60%</span>
        </div>

        <div class="row" style="font-size: 11px; color: #888;">
          <span class="label">Velocity</span>
          <span id="stencilVelocity" class="pill" style="background: rgba(168, 85, 247, 0.2); color: #a78bfa;">0.0 m/s</span>
        </div>

        <div class="row">
          <button id="clearPiP4Stencil" class="save-btn">Clear Line Stencil</button>
        </div>
        </div>
      </div>

      <!-- Contact Filters -->
      <div class="section">
        <div class="section-title red collapsible" data-target="contactFiltersDetails">
          <span class="toggle-icon">▼</span> Contact Filters (Debug)
        </div>
        <div id="contactFiltersDetails" class="section-details">
        <div class="row">
          <p style="font-size: 10px; color: #999; margin: 0;">Toggle filters for debugging soft body contact acquisition</p>
        </div>

        <div class="row">
          <label><input type="checkbox" id="enableHysteresis" checked /> Hysteresis</label>
          <label><input type="checkbox" id="enableVelocityGate" checked /> Velocity Gate</label>
        </div>

        <div class="row">
          <label><input type="checkbox" id="enableDistanceFilter" checked /> Distance Filter</label>
          <label><input type="checkbox" id="enableGridDedupe" checked /> Grid Dedupe</label>
        </div>

        <div class="row">
          <label><input type="checkbox" id="enableIQROutlier" checked /> IQR Outlier</label>
          <label><input type="checkbox" id="enableNeighborSupport" checked /> Neighbor Support</label>
        </div>

        <div class="row">
          <label><input type="checkbox" id="enableEMASmoothing" checked /> EMA Smoothing</label>
          <label><input type="checkbox" id="enableHoldLast" checked /> Hold Last</label>
        </div>

        <div class="row">
          <label><input type="checkbox" id="enableQualityGates" checked /> Quality Gates</label>
        </div>

        <div class="row">
          <button id="filtersAllOn" class="save-btn">All On</button>
          <button id="filtersAllOff" class="save-btn">All Off</button>
          <button id="filtersSoftBody" class="save-btn">Soft Body Preset</button>
        </div>
        </div>
      </div>

      <!-- UV Paint -->
      <div class="section">
        <div class="section-title purple collapsible" data-target="uvPaintDetails">
          <span class="toggle-icon">▼</span> UV Paint
        </div>
        <div id="uvPaintDetails" class="section-details">
        <div class="row">
          <label><input type="checkbox" id="enableUVPaint" /> Enable UV Paint</label>
        </div>
        <div class="row">
          <button id="clearUVPaint" class="save-btn">Clear UV Paint</button>
          <button id="saveUVPaint" class="save-btn">Save UV Paint</button>
        </div>
        </div>
      </div>
      
      <!-- Field Intensity Layer -->
      <div class="section">
        <div class="section-title green collapsible" data-target="fieldIntensityDetails">
          <span class="toggle-icon">▼</span> Field Intensity (Grayscale)
        </div>
        <div id="fieldIntensityDetails" class="section-details">
        <div class="row">
          <label><input type="checkbox" id="enableField" checked /> Enable Field</label>
          <label><input type="checkbox" id="showField" /> Show Field</label>
        </div>
        <div class="row">
          <span class="label">Field Gain (speed)</span>
          <input id="fieldGain" type="range" min="1" max="100" value="2" step="1" />
          <span id="fieldGainValue" class="pill">0.02</span>
        </div>
        <div class="row">
          <p style="font-size: 10px; color: #999; margin: 0;">500 passes = white (fixed target)</p>
        </div>
        <div class="row" style="font-size: 11px; color: #888;">
          <span class="label">Normal Force</span>
          <span id="normalForce" class="pill" style="background: rgba(34, 197, 94, 0.2); color: #4ade80;">0 N</span>
        </div>
        <div class="row">
          <button id="clearField" class="save-btn">Clear Field</button>
          <button id="saveField" class="save-btn">Save Field</button>
        </div>
        </div>
      </div>
      
      <!-- Flow Direction Layer -->
      <div class="section">
        <div class="section-title cyan collapsible" data-target="flowMapDetails">
          <span class="toggle-icon">▼</span> Flow Map (HSV)
        </div>
        <div id="flowMapDetails" class="section-details">
        <div class="row">
          <label><input type="checkbox" id="enableFlow" checked /> Enable Flow</label>
          <label><input type="checkbox" id="showFlow" /> Show Flow</label>
        </div>
        <div class="row">
          <span class="label">Flow Alpha</span>
          <input id="flowAlpha" type="range" min="1" max="50" value="15" step="1" />
          <span id="flowAlphaValue" class="pill">0.15</span>
        </div>
        <div class="row">
          <span class="label">Similarity Threshold</span>
          <input id="flowSimilarity" type="range" min="0" max="100" value="50" step="1" />
          <span id="flowSimilarityValue" class="pill">0.50</span>
        </div>
        <div class="row">
          <button id="clearFlow" class="save-btn">Clear Flow</button>
          <button id="saveFlow" class="save-btn">Save Flow</button>
        </div>
        </div>
      </div>
      
      <!-- Export Controls Section -->
      <div class="section">
        <div class="section-title cyan collapsible" data-target="exportDetails">
          <span class="toggle-icon">▼</span> Export
        </div>
        <div id="exportDetails" class="section-details">
          <div class="row">
            <button id="exportPiP1" class="save-btn">Export Top View</button>
            <button id="exportPiP2" class="save-btn">Export Bottom View</button>
          </div>
          <div class="row">
            <button id="exportPiP3" class="save-btn">Export Intersection</button>
            <button id="exportPiP4" class="save-btn">Export Line Stencil</button>
          </div>
          <div class="row">
            <button id="saveIntersection" class="save-btn">Export All Views</button>
          </div>
        </div>
      </div>
      
    </div>

  </div>

  <div class="pip-container scrollable" id="pipContainer">
    <div id="pip1" class="pip">
      <div class="pip-label">Top View (+n)</div>
      <canvas id="pip1Canvas" width="512" height="512"></canvas>
    </div>
    <div id="pip2" class="pip">
      <div class="pip-label">Bottom View (-n)</div>
      <canvas id="pip2Canvas" width="512" height="512"></canvas>
    </div>
    <div id="pip3" class="pip">
      <div class="pip-label">Intersection</div>
      <canvas id="pip3Canvas" width="512" height="512"></canvas>
    </div>
    <div id="pip4" class="pip">
      <div class="pip-label">Line Stencil</div>
      <canvas id="pip4Canvas" width="512" height="512"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/gh/kripken/ammo.js@HEAD/builds/ammo.js"></script>
  <script type="importmap">
  {"imports":{
    "three":"https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
    "three/addons/":"https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/"
  }}
  </script>
  <script type="module" src="js/main-clean-complete.js"></script>
</body>
</html>
